<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#000000" />

    <title>dicom-microscopy-viewer example</title>

    <!-- Latest compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
      integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
      integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0="
      crossorigin="anonymous"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jscolor/2.0.4/jscolor.min.js" 
      integrity="sha256-CJWfUCeP3jLdUMVNUll6yQx37gh9AKmXTRxvRf7jzro=" 
      crossorigin="anonymous">
    </script>
    
  </head>

  <body>
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>

    <script src="https://unpkg.com/dicomweb-client"></script>
    <!-- <script src="https://unpkg.com/dicom-microscopy-viewer"></script> -->
    <script src="../../build/dicom-microscopy-viewer.js"></script>
    <script>

      document.addEventListener("DOMContentLoaded", () => {

        document.getElementById("tools-list").addEventListener("click", (event) => {
          const geometryType = event.target.id
          disableToolList()

          const style = new DICOMMicroscopyViewer.style.ToolStyle(getStyle())

          window.viewer.activateDrawInteraction({ geometryType, style })
          document.getElementById(`${geometryType}`).setAttribute("class", "list-group-item active")          
        })

        const elements = ["stroke", "width", "fill_color", "point_color", "point_radius", "text"]
                            .map(document.getElementById, document)

        elements.forEach(e => {
          e.addEventListener("change", (event) => {
            const style = new DICOMMicroscopyViewer.style.ToolStyle(getStyle())
            const geometryType = document.getElementById("tools-list").querySelector("a.active").id
            window.viewer.activateDrawInteraction({ geometryType, style })
          })
        })

      })

      function getStyle(){
        const styleOptions = {
          stroke : {
            color: `#${document.getElementById('stroke').value}`, 
            width: document.getElementById('width').value
          },
          fill : {
            color: `${hexToRgbA(document.getElementById('fill_color').value)}`
          },
          circle : {
            radius: `${document.getElementById('point_radius').value}`,
            color: `#${document.getElementById('point_color').value}`
          },
          text : {
            text : `${document.getElementById('text').value}`
          }
        }

        return styleOptions
      }

      function disableToolList(){
        const toolList = document.getElementById("tools-list").querySelector("a.active")
        if(toolList !== null){
          toolList.classList.remove("active")
        }
      }

      function hexToRgbA(hex){
        let c
        if(/^([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
            c = hex.substring(1).split('')
            if(c.length== 3){
                c= [c[0], c[0], c[1], c[1], c[2], c[2]]
            }
            c = '0x'+c.join('')
            return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+',0.1)'
        }
        throw new Error('Bad Hex')
    }

      const url = "https://server.dcmjs.org/dcm4chee-arc/aets/DCM4CHEE/rs"
      const client = new DICOMwebClient.api.DICOMwebClient({ url })
      const studyInstanceUID = "1.2.392.200140.2.1.1.1.2.799008771.2448.1519719572.518"
      const seriesInstanceUID = "1.2.392.200140.2.1.1.1.3.799008771.2448.1519719572.519"

      const searchInstanceOptions = {
        studyInstanceUID,
        seriesInstanceUID
      }

      client.searchForInstances(searchInstanceOptions)
        .then(instances => {
          const promises = []

          for (let i = 0; i < instances.length; i++) {

            const sopInstanceUID = instances[i]["00080018"]["Value"][0]

            const retrieveInstanceOptions = {
              studyInstanceUID,
              seriesInstanceUID,
              sopInstanceUID
            }

            const promise = client.retrieveInstanceMetadata(retrieveInstanceOptions)
              .then(metadata => {
                const imageType = metadata[0]["00080008"]["Value"]
                if (imageType[2] === "VOLUME") {
                  return metadata[0]
                }
              })
            promises.push(promise)
          }
          return Promise.all(promises)
        })
        .then(metadata => {
          metadata = metadata.filter(m => m)

          const style = new DICOMMicroscopyViewer.style.ToolStyle(getStyle())
          const viewer = new DICOMMicroscopyViewer.api.VLWholeSlideMicroscopyImageViewer({client, metadata, style})

          const container = document.getElementById("dicomImage")
          viewer.render({ container })

          viewer.activateDrawInteraction({ geometryType: "polygon" })
          window.viewer = viewer

        })

    </script>
  </body>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>
          Microscopy viewer Style Customization
        </h1>
        <p>
          This example demonstrates how to customize the styling with Microscopy viewer.
        </p>
        <a href="../">Go back to the Examples page</a>
      </div>

      <div class="bs-example" data-example-id="simple-thumbnails">
        <div class="row">
          <div class="col-xs-6 col-md-4" >
              <div class="alert alert-warning text-center" role="alert">Stroke styling options</div>
              
                <div class="form-group row">
                  <label class="col-sm-2 col-form-label" for="stroke">Stroke</label>
                  <div class="col-sm-10">
                    <input class="form-control-plaintext jscolor" id="stroke" value="ab2567">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-sm-2 col-form-label" for="width">Width</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control-plaintext" id="width" value="1">
                  </div>
                </div>

                <div class="alert alert-warning text-center" role="alert">Fill</div>

                <div class="form-group row">
                  <label class="col-sm-2 col-form-label" for="fill_color">Color</label>
                  <div class="col-sm-10">
                    <input type="text" class="form-control-plaintext jscolor" id="fill_color" value="CFB2C6">
                  </div>
                </div>
          </div>
          <div class="col-xs-6 col-md-4" >
              <div class="alert alert-warning text-center" role="alert">Point styling options</div>

              <div class="form-group row">
                <label class="col-sm-2 col-form-label" for="point_color">Color</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control-plaintext jscolor" id="point_color" value="0EAB72">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label" for="point_radius">Radius</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control-plaintext" id="point_radius" value="5">
                </div>
              </div>

              <div class="alert alert-warning text-center" role="alert">Text styling options</div>

              <div class="form-group row">
                <label class="col-sm-2 col-form-label" for="text">Text</label>
                <div class="col-sm-10">
                  <input type="text" class="form-control-plaintext" id="text" value="">
                </div>
              </div>

          </div>
          <div class="col-xs-12 col-md-4" >
            <div class="alert alert-warning text-center" role="alert">Then, Select the tool to use for drawing</div>
            <div class="list-group" id="tools-list">
              <a id="polygon" class="list-group-item active">Polygon</a>
              <a id="point" class="list-group-item">Point</a>
              <a id="circle" class="list-group-item">Circle</a>
              <a id="box" class="list-group-item">Box</a>
              <a id="freehandpolygon" class="list-group-item">Freehand Polygon</a>
              <a id="line" class="list-group-item">Line</a>
              <a id="freehandline" class="list-group-item">Freehand Line</a>
            </div>
            <br/>
          </div>          
          
          <div class="col-xs-12 col-md-12">
            <div
              style="width:100%;height:550px;position:relative;display:inline-block"
              oncontextmenu="return false"
              class="cornerstone-enabled-image"
              unselectable="on"
              onselectstart="return false"
              onmousedown="return false"
            >
              <div
                id="dicomImage"
                style="width:100%;height:550px;top:0px;left:0px; position:absolute; border: 1px solid black"
              ></div>

            </div>
          </div>
        </div>
      </div>
    </div>
    <style>
    .scrollable {
      height: 600px;
      overflow-y: scroll
    }
    #rois li {
      list-style-type: none
    }
    </style>
  </body>
</html>
